se)) {
        return NextResponse.json(
          {
            ok: false,
            command,
            error: {
              code: "MISSING_AP2_WORKER_BASE_URL",
              message:
                "AP2_WORKER_BASE_URL is not set (or not http/https) in this Vercel project environment.",
            },
          },
          { status: 500 }
        );
      }

      try {
        const res = await fetch(`${workerBase}/api/ap2/status`, {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify(args || {}),
        });

        const data = await res.json().catch(() => ({}));
        return NextResponse.json(
          { ok: res.ok, command, data: { workerBase, http: res.status, data } },
          { status: res.ok ? 200 : 502 }
        );
      } catch (e: any) {
        return NextResponse.json(
          {
            ok: false,
            command,
            error: {
              code: "AP2_FETCH_FAILED",
              message: "Failed to reach AP2 worker (/api/ap2/status).",
              extra: String(e?.message ?? e),
            },
          },
          { status: 502 }
        );
      }
    }

    case "ap2.task.enqueue": {
      // Proxy to AP2 (authoritative)
      const base = ap2Base();
      const auth = hx2AuthHeader(req);

      const bodyAny: any = (typeof body !== "undefined" ? body : {}) as any;
      const taskType = String(bodyAny.taskType || bodyAny.task || "").trim();
      const payload  = bodyAny.payload ?? {};
      const note     = bodyAny.note ? String(bodyAny.note) : undefined;

      if (!taskType) {
        return NextResponse.json({ ok: false, command, error: { code: "MISSING_TASK_TYPE", message: "taskType is required" } }, { status: 400 });
      }

      const url = `${base}/api/ap2/task/enqueue`;
      const proxyRes = await fetch(url, {
        method: "POST",
        headers: {
          "content-type": "application/json",
          ...(auth ? { authorization: auth } : {})
        },
        body: JSON.stringify({ mode: "SAFE", taskType, payload, note })
      });

      const proxyJson = await proxyRes.json().catch(() => ({}));
      return NextResponse.json(
        { ok: proxyRes.ok, command, data: proxyJson, http: proxyRes.status, workerBase: base },
        { status: proxyRes.ok ? 200 : 502, headers: { "x-hx2-ap2-proxy": "enqueue-v1" } }
      );
}

    case "ap2.task.status":
      return ok(command, { taskId: args?.taskId ?? null, state: "UNKNOWN", note: "Stubbed until DB model exists" });

    case "ap2.task.list":
      return ok(command, { tasks: [], note: "Stubbed until DB model exists" });

    default:
      return err(command, "NOT_IMPLEMENTED", "Command not implemented in canonical hx2 route yet");
  }
}
